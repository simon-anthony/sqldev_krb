@ECHO off
REM krb_pkinit: Get TGT from certificate

SETLOCAL enabledelayedexpansion

REM realm in upper case
SET REALM=%USERDNSDOMAIN%
CALL :toUpper REALM
REM domain in lower case
SET DOMAIN=%USERDNSDOMAIN%
CALL :toLower DOMAIN

SET PRINCIPAL=%USERNAME%@%REALM%

SET X509_PROXY=FILE:!CERTDIR!\%USERNAME%.crt,!KEYDIR!\%USERNAME%.key
SET X509_ANCHORS=FILE:!CERTDIR!\ca.crt

:parse
IF "%1" == "" GOTO endparse

SET option=%~1
SET arg=%~2

IF "%option%" == "-c" (
	SHIFT 
	IF NOT "%arg:~0,1%" == "-" (
		SET KRB5CCNAME=%arg%
		SHIFT
	) ELSE (
		GOTO usage
	)
	SET CFLAG=y
) ELSE IF "%option%" == "-h" (
	SHIFT 
	IF NOT "%arg:~0,1%" == "-" (
		SET SQLDEV_HOME=%arg%
		SHIFT
	) ELSE (
		GOTO usage
	)
	SET HFLAG=y
) ELSE IF "%option%" == "-e" (
	SHIFT
	SET EFLAG=y
) ELSE IF "%option%" == "-x" (
	SHIFT
	SET XFLAG=y
) ELSE (
	GOTO usage
)

GOTO parse
:endparse

IF "%SQLDEV_HOME%" == "" (
	ECHO SQLDEV_HOME must be set in the environment or set with -h
	EXIT /B 1
)
IF NOT EXIST !SQLDEV_HOME!\sqldeveloper.exe (
	ECHO Invalid SQL Developer home
	EXIT /B 1
)
SET KRB5_CONFIG=!SQLDEV_HOME!\jdk\jre\conf\security\krb5.conf

IF "%CFLAG%" == "" (
	REM This is the default cache unless overridden by specifying KRB5CCNAME
	REM JDK kinit uses %HOMEPATH%\krb5cc_%USERNAME%
	REM SET KRB5CCNAME=%LOCALAPPDATA%\krb5cc_%USERNAME%
	SET KRB5CCNAME=FILE:%%{LOCAL_APPDATA}\krb5cc_%%{username}
	SET KRB5_KTNAME=FILE:%%{LOCAL_APPDATA}\krb5_%%{username}.keytab
)
IF NOT "!EFLAG!" == "" (
	ECHO kconf 
	EXIT /B 0
)
IF NOT "!XFLAG!" == "" (
	SET KRB5_TRACE=%TEMP%\krb5_trace.log
	ECHO. > !KRB5_TRACE!
)

echo Krb5.conf: !KRB5_CONFIG!
CALL :createkrb5conf

IF NOT EXIST !SQLDEV_HOME!\sqldeveloper\bin\kerberos.conf (
	ECHO. >> !SQLDEV_HOME!\sqldeveloper\bin\sqldeveloper-nondebug.conf
	ECHO IncludeConfFile kerberos.conf >> !SQLDEV_HOME!\sqldeveloper\bin\sqldeveloper-nondebug.conf
)

ECHO AddVMOption -Djava.security.krb5.conf=!KRB5_CONFIG! > !SQLDEV_HOME!\sqldeveloper\bin\kerberos.conf

ENDLOCAL
EXIT /B 0

:usage
	ECHO Usage: krb_conf  [-h ^<sqldev_home^>]
	ECHO   -h ^<sqldev_home^>    specify SQL Developer home (default: !SQLDEV_HOME!^)
	ECHO   -e                 echo the command only
ENDLOCAL
EXIT /B 1

:createkrb5conf
	REM create a krb5.conf for SQL Developer
	ECHO # Generated by krb_conf > !KRB5_CONFIG!
	ECHO [domain_realm] >> !KRB5_CONFIG!
	ECHO         .!DOMAIN! = !REALM! >> !KRB5_CONFIG!
	ECHO         !DOMAIN! = !REALM! >> !KRB5_CONFIG!
	ECHO. >> !KRB5_CONFIG!
	ECHO [libdefaults] >> !KRB5_CONFIG!
	ECHO         default_realm = !REALM! >> !KRB5_CONFIG!
	ECHO         default_ccache_name = !KRB5CCNAME! >> !KRB5_CONFIG!
	ECHO         default_client_keytab_name = !KRB5_KTNAME! >> !KRB5_CONFIG!
	ECHO #        verify_ap_req_nofail = false >> !KRB5_CONFIG!
	ECHO #        dns_lookup_kdc = false >> !KRB5_CONFIG!
	ECHO. >> !KRB5_CONFIG!
	ECHO [realms] >> !KRB5_CONFIG!
	ECHO         !REALM! = { >> !KRB5_CONFIG!
	ECHO             admin_server = win-bts6cdsef76.example.com >> !KRB5_CONFIG!
	ECHO             kdc = win-bts6cdsef76.example.com >> !KRB5_CONFIG!
	ECHO             kpasswd_protocol = SET_CHANGE >> !KRB5_CONFIG!
	ECHO             # pkinit_anchors = DIR:/etc/certs/CA >> !KRB5_CONFIG!
	ECHO             pkinit_eku_checking = kpServerAuth >> !KRB5_CONFIG!
	ECHO             pkinit_kdc_hostname = win-bts6cdsef76.example.com >> !KRB5_CONFIG!
	ECHO         } >> !KRB5_CONFIG!
EXIT /B

:toUpper str
	FOR %%a IN ("a=A" "b=B" "c=C" "d=D" "e=E" "f=F" "g=G" "h=H" "i=I"
		"j=J" "k=K" "l=L" "m=M" "n=N" "o=O" "p=P" "q=Q" "r=R"
		"s=S" "t=T" "u=U" "v=V" "w=W" "x=X" "y=Y" "z=Z") DO (
		CALL SET %~1=%%%~1:%%~a%%
	)
EXIT /B 0

:toLower str
	FOR %%a IN ("A=a" "B=b" "C=c" "D=d" "E=e" "F=f" "G=g" "H=h" "I=i"
		"J=j" "K=k" "L=l" "M=m" "N=n" "O=o" "P=p" "Q=q" "R=r"
		"S=s" "T=t" "U=u" "V=v" "W=w" "X=x" "Y=y" "Z=z") DO (
		CALL SET %~1=%%%~1:%%~a%%
	)
EXIT /B 0
